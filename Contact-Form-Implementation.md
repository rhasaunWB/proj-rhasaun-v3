# Contact Form Implementation Guide

## Overview
The contact form on the Halcyon website is a Full-Stack integration that captures user inquiries and saves them directly to a Notion database. It consists of a React-based frontend form (using `react-hook-form`) and a serverless API endpoint (hosted on Vercel) that communicates with the Notion API.

## Architecture

1.  **Frontend**: 
    *   **Component**: `FooterWithForm.tsx`
    *   **Library**: `react-hook-form` forms management.
    *   **Validation**: Client-side validation for required fields and email format.
    *   **Security**: Uses a site token (`x-site-token`) to authorize requests to the API.

2.  **Backend API**:
    *   **Endpoint**: `/api/submit-contact`
    *   **Platform**: Vercel Serverless Function.
    *   **Integration**: `@notionhq/client` to insert pages into a specific Notion Database.
    *   **Security**: Validates the `x-site-token` header against the server-side environment variable.

---

## Configuration & Setup

### 1. Environment Variables
The system relies on environment variables for security and configuration.

**Frontend (`.env` or Vercel Environment Variables):**
```env
VITE_SITE_TOKEN=your_secure_random_token_here
```

**Backend (Vercel Environment Variables):**
```env
SITE_TOKEN=your_secure_random_token_here   # Must match VITE_SITE_TOKEN
NOTION_API_KEY=secret_...                  # Your Notion Integration Token
NOTION_DATABASE_ID=...                     # The ID of the Notion Database
```

### 2. Notion Database Schema
For the API to successfully save data, your Notion Database must have the following properties (case-sensitive):

| Property Name  | Type       | Description |
| :---           | :---       | :--- |
| **Name**       | Title      | The name of the person submitting the form. |
| **Email**      | Email      | Contact email address. |
| **Message**    | Rich Text  | The body of the message. |
| **Submitted At**| Date      | Timestamp of submission (auto-generated by API). |

---

## Code Implementation Details

### Frontend: `FooterWithForm.tsx`
Located in `site/src/app/reimagined/components/FooterWithForm.tsx`.

**Key Features:**
*   **Form State**: Managed via `useForm<ContactFormData>()`.
*   **Submission Handler**: `onSubmit` function sends a POST request to `/api/submit-contact`.
*   **Feedback**: Uses `toast` (from `sonner`) to show success/error messages.
*   **Loading State**: Displays a spinner (`Loader2` icon) during submission.

**Snippet:**
```typescript
const onSubmit = async (data: ContactFormData) => {
    try {
        const siteToken = import.meta.env.VITE_SITE_TOKEN;
        const response = await fetch('/api/submit-contact', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'x-site-token': siteToken || ''
            },
            body: JSON.stringify({ ...data, source: 'Website Footer' }),
        });
        // Handle response...
    } catch (error) {
        // Handle error...
    }
};
```

### Backend: `submit-contact.js`
Located in `site/api/submit-contact.js`.

**Key Logic:**
1.  **Method Check**: Only allows `POST` requests.
2.  **Token Verification**: Checks `req.headers['x-site-token']` against `process.env.SITE_TOKEN`.
3.  **Notion Client**: Initializes `new Client({ auth: process.env.NOTION_API_KEY })`.
4.  **Create Page**: Calls `notion.pages.create` mapping the JSON body to Notion properties.

**Snippet:**
```javascript
await notion.pages.create({
    parent: { database_id: process.env.NOTION_DATABASE_ID },
    properties: {
        Name: { title: [{ text: { content: name } }] },
        Email: { email: email },
        // ... mapping other fields
    }
});
```

---

## Troubleshooting

1.  **Form Submission Fails (401 Unauthorized)**:
    *   Check that `VITE_SITE_TOKEN` in your local `.env` or Vercel Frontend Env vars matches `SITE_TOKEN` in the Vercel Backend Env vars.

2.  **Form Submission Fails (500 Server Error)**:
    *   Check `NOTION_API_KEY` and `NOTION_DATABASE_ID` are correct.
    *   **Important**: Ensure the Notion Integration (connected to the API Key) has been **added as a connection** to the specific Notion Database page.

3.  **Properties Not Showing in Notion**:
    *   Verify the property names in Notion exactly match the keys used in `submit-contact.js` (e.g., "Service", "Stage"). If you rename them in Notion, you must update the API code.
